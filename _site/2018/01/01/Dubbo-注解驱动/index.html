<h1 id="dubbo-注解驱动annotation-driven">Dubbo 注解驱动（Annotation-Driven）</h1>

<h2 id="主目录"><a href="Dubbo-New-Programming-Model.md">主目录</a></h2>

<h2 id="注解驱动annotation-driven">注解驱动（Annotation-Driven）</h2>

<h3 id="dubbocomponentscan"><code class="highlighter-rouge">@DubboComponentScan</code></h3>

<h4 id="起始版本-257">起始版本： <code class="highlighter-rouge">2.5.7</code></h4>

<h4 id="dubboannotation-历史遗留问题"><code class="highlighter-rouge">&lt;dubbo:annotation&gt; </code>历史遗留问题</h4>

<h5 id="1-注解支持不充分">1. 注解支持不充分</h5>

<p>在 Dubbo  <code class="highlighter-rouge">2.5.7</code>之前的版本 ，Dubbo 提供了两个核心注解 <code class="highlighter-rouge">@Service</code> 以及 <code class="highlighter-rouge">@Reference</code>，分别用于Dubbo 服务提供和 Dubbo 服务引用。</p>

<p>其中，<code class="highlighter-rouge">@Service</code> 作为 XML 元素 <code class="highlighter-rouge">&lt;dubbo:service&gt;</code>的替代注解，与 Spring Framework <code class="highlighter-rouge">@org.springframework.stereotype.Service</code> 类似，用于服务提供方 Dubbo 服务暴露。与之相对应的<code class="highlighter-rouge">@Reference</code>，则是替代<code class="highlighter-rouge">&lt;dubbo:reference</code> 元素，类似于 Spring 中的 <code class="highlighter-rouge">@Autowired</code>。</p>

<p><code class="highlighter-rouge">2.5.7</code> 之前的Dubbo，与早期的 Spring Framework 2.5 存在类似的不足，即注解支持不够充分。注解需要和 XML 配置文件配合使用，如下所示：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xmlns:dubbo=</span><span class="s">"http://code.alibabatech.com/schema/dubbo"</span>
       <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
	http://code.alibabatech.com/schema/dubbo http://code.alibabatech.com/schema/dubbo/dubbo.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;dubbo:application</span> <span class="na">name=</span><span class="s">"annotation-provider"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dubbo:registry</span> <span class="na">address=</span><span class="s">"127.0.0.1:4548"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dubbo:annotation</span> <span class="na">package=</span><span class="s">"com.alibaba.dubbo.config.spring.annotation.provider"</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h5 id="2--service-bean-不支持-spring-aop">2.  <code class="highlighter-rouge">@Service</code> Bean 不支持 Spring AOP</h5>

<p>同时，使用 <code class="highlighter-rouge">&lt;dubbo:annotation&gt; </code> 方式扫描后的Dubbo <code class="highlighter-rouge">@Service</code> ，在 Spring 代理方面存在问题，如 GitHub 上的 issue https://github.com/alibaba/dubbo/issues/794：</p>

<blockquote>
  <p>关于dubbo @Service注解生成ServiceBean时, interface获取成spring 的代理对象的bug</p>

  <blockquote>
    <p>在项目里， 我使用了</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="nd">@com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">config</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SUserJpushServiceImp</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>

    <p>的形式， 来暴露服务。但是在发布服务的时候， interface class 是通过
<code class="highlighter-rouge">
serviceConfig.setInterface(bean.getClass().getInterfaces()[0]);
</code>
的形式获取， 刚好， 我的service都使用了@Transactional注解， 对象被代理了。所以获取到的interface是Spring的代理接口…</p>
  </blockquote>
</blockquote>

<p>不少热心的小伙伴不仅发现这个历史遗留问题，而且提出了一些修复方案。同时，为了更好地适配 Spring 生命周期以及将 Dubbo 完全向注解驱动编程模型过渡，因此，引入了全新 Dubbo 组件扫描注解 - <code class="highlighter-rouge">@DubboComponentScan</code>。</p>

<blockquote>
  <p>注： <code class="highlighter-rouge">&lt;dubbo:annotation&gt; </code>  Spring AOP 问题将在 <code class="highlighter-rouge">2.5.9</code> 中修复：https://github.com/alibaba/dubbo/issues/1125</p>
</blockquote>

<h5 id="3-reference-不支持字段继承性">3. @Reference 不支持字段继承性</h5>

<p>假设有一个 Spring Bean <code class="highlighter-rouge">AnnotationAction</code> 直接通过字段<code class="highlighter-rouge">annotationService</code> 标记 <code class="highlighter-rouge">@Reference</code> 引用 <code class="highlighter-rouge">AnnotationService</code> ：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">examples</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">action</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.alibaba.dubbo.config.annotation.Reference</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.alibaba.dubbo.examples.annotation.api.AnnotationService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>


<span class="nd">@Component</span><span class="o">(</span><span class="s">"annotationAction"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AnnotationAction</span> <span class="o">{</span>

    <span class="nd">@Reference</span>
    <span class="kd">private</span> <span class="n">AnnotationService</span> <span class="n">annotationService</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">doSayHello</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">annotationService</span><span class="o">.</span><span class="na">sayHello</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>当<code class="highlighter-rouge">AnnotationAction</code>  被 XML 元素 <code class="highlighter-rouge">&lt;dubbo:annotation&gt;</code> 扫描后：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;dubbo:annotation</span> <span class="na">package=</span><span class="s">"com.alibaba.dubbo.examples.annotation.action"</span><span class="nt">/&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>字段 <code class="highlighter-rouge">annotationService</code> 能够引用到 <code class="highlighter-rouge">AnnotationService</code>，执行 <code class="highlighter-rouge">doSayHello</code> 方法能够正常返回。</p>

<p>如果将字段<code class="highlighter-rouge">annotationService</code>  抽取到<code class="highlighter-rouge">AnnotationAction</code> 的父类<code class="highlighter-rouge">BaseAction</code> 后，<code class="highlighter-rouge">AnnotationService</code> 无法再被引用，改造如下所示：</p>

<p><code class="highlighter-rouge">AnnotationAction.java</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="nd">@Component</span><span class="o">(</span><span class="s">"annotationAction"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AnnotationAction</span> <span class="kd">extends</span> <span class="n">BaseAction</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">doSayHello</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">getAnnotationService</span><span class="o">().</span><span class="na">sayHello</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="highlighter-rouge">BaseAction.java</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">BaseAction</span> <span class="o">{</span>

    <span class="nd">@Reference</span>
    <span class="kd">private</span> <span class="n">AnnotationService</span> <span class="n">annotationService</span><span class="o">;</span>

    <span class="kd">protected</span> <span class="n">AnnotationService</span> <span class="nf">getAnnotationService</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">annotationService</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>改造后，再次执行 <code class="highlighter-rouge">doSayHello</code> 方法，<code class="highlighter-rouge">NullPointerException</code> 将会被抛出。说明<code class="highlighter-rouge">&lt;dubbo:annotation&gt;</code> 并不支持<code class="highlighter-rouge">@Reference</code> 字段继承性。</p>

<p>了解了历史问题，集合整体愿景，下面介绍<code class="highlighter-rouge">@DubboComponentScan</code> 的设计原则。</p>

<h4 id="设计原则">设计原则</h4>

<p>Spring Framework 3.1 引入了新 Annotation - <code class="highlighter-rouge">@ComponentScan</code> ， 完全替代了 XML 元素 ` <context:component-scan>` 。同样， `@DubboComponentScan`  作为 Dubbo `2.5.7` 新增的 Annotation，也是XML 元素  `<dubbo:annotation>` 的替代方案。</dubbo:annotation></context:component-scan></p>

<p>在命名上（类名以及属性方法），为了简化使用和关联记忆，Dubbo 组件扫描 Annotation <code class="highlighter-rouge">@DubboComponentScan</code>，借鉴了 Spring Boot 1.3 引入的 <code class="highlighter-rouge">@ServletComponentScan</code>。定义如下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="nd">@interface</span> <span class="n">DubboComponentScan</span> <span class="o">{</span>

    <span class="cm">/**
     * Alias for the {@link #basePackages()} attribute. Allows for more concise annotation
     * declarations e.g.: {@code @DubboComponentScan("org.my.pkg")} instead of
     * {@code @DubboComponentScan(basePackages="org.my.pkg")}.
     *
     * @return the base packages to scan
     */</span>
    <span class="n">String</span><span class="o">[]</span> <span class="nf">value</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="cm">/**
     * Base packages to scan for annotated @Service classes. {@link #value()} is an
     * alias for (and mutually exclusive with) this attribute.
     * &lt;p&gt;
     * Use {@link #basePackageClasses()} for a type-safe alternative to String-based
     * package names.
     *
     * @return the base packages to scan
     */</span>
    <span class="n">String</span><span class="o">[]</span> <span class="nf">basePackages</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="cm">/**
     * Type-safe alternative to {@link #basePackages()} for specifying the packages to
     * scan for annotated @Service classes. The package of each class specified will be
     * scanned.
     *
     * @return classes from the base packages to scan
     */</span>
    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">basePackageClasses</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>注意：<code class="highlighter-rouge">basePackages()</code> 和 <code class="highlighter-rouge">value()</code> 均能支持占位符（placeholder）指定的包名</p>
</blockquote>

<p>在职责上，<code class="highlighter-rouge">@DubboComponentScan</code> 相对于 Spring Boot <code class="highlighter-rouge">@ServletComponentScan</code> 更为繁重，原因在于处理 Dubbo  <code class="highlighter-rouge">@Service</code> 类暴露 Dubbo 服务外，还有帮助 Spring  Bean <code class="highlighter-rouge">@Reference</code>字段或者方法注入 Dubbo 服务代理。</p>

<p>在场景上，Spring Framework <code class="highlighter-rouge">@ComponentScan</code> 组件扫描逻辑更为复杂。而在 <code class="highlighter-rouge">@DubboComponentScan</code>  只需关注 <code class="highlighter-rouge">@Service</code> 和 <code class="highlighter-rouge">@Reference</code> 处理。</p>

<p>在功能上， <code class="highlighter-rouge">@DubboComponentScan</code>  不但需要提供完整 Spring AOP 支持的能力，而且还得具备<code class="highlighter-rouge">@Reference </code> 字段可继承性的能力。</p>

<p>了解基本设计原则后，下面通过完整的示例，简介<code class="highlighter-rouge">@DubboComponentScan</code> 使用方法以及注意事项。</p>

<h4 id="使用方法">使用方法</h4>

<p>后续通过服务提供方（<code class="highlighter-rouge">@Serivce</code>）以及服务消费方（<code class="highlighter-rouge">@Reference</code>）两部分来介绍<code class="highlighter-rouge">@DubboComponentScan</code> 使用方法。</p>

<p>假设，服务提供方和服务消费分均依赖服务接口<code class="highlighter-rouge">DemoService</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">demo</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">DemoService</span> <span class="o">{</span>

    <span class="n">String</span> <span class="nf">sayHello</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">);</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h5 id="服务提供方serivce">服务提供方（<code class="highlighter-rouge">@Serivce</code>）</h5>

<h6 id="实现-demoservice">实现 <code class="highlighter-rouge">DemoService</code></h6>

<p>服务提供方实现<code class="highlighter-rouge">DemoService</code>  - <code class="highlighter-rouge">AnnotationDemoService</code> ，同时标注 Dubbo <code class="highlighter-rouge">@Service</code> ：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">provider</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.alibaba.dubbo.config.annotation.Service</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.alibaba.dubbo.demo.DemoService</span><span class="o">;</span>

<span class="cm">/**
 * Annotation {@link DemoService} 实现
 *
 * @author &lt;a href="mailto:mercyblitz@gmail.com"&gt;Mercy&lt;/a&gt;
 */</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AnnotationDemoService</span> <span class="kd">implements</span> <span class="n">DemoService</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">sayHello</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"Hello , "</span> <span class="o">+</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h6 id="服务提供方-annotation-配置">服务提供方 Annotation 配置</h6>

<p>将 <code class="highlighter-rouge">AnnotationDemoService</code> 暴露成Dubbo 服务，需要依赖 Spring Bean：<code class="highlighter-rouge">AplicationConfig</code>、<code class="highlighter-rouge">ProtocolConfig</code> 以及 <code class="highlighter-rouge">RegistryConfig</code>  。这三个 Spring Bean 过去可通过 XML 文件方式组装 Spring Bean：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;beans</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xmlns:dubbo=</span><span class="s">"http://code.alibabatech.com/schema/dubbo"</span>
       <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
    http://code.alibabatech.com/schema/dubbo http://code.alibabatech.com/schema/dubbo/dubbo.xsd
    "</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- 当前应用信息配置 --&gt;</span>
    <span class="nt">&lt;dubbo:application</span> <span class="na">name=</span><span class="s">"dubbo-annotation-provider"</span><span class="nt">/&gt;</span>

    <span class="c">&lt;!-- 连接注册中心配置 --&gt;</span>
    <span class="nt">&lt;dubbo:registry</span> <span class="na">id=</span><span class="s">"my-registry"</span> <span class="na">address=</span><span class="s">"N/A"</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;dubbo:protocol</span> <span class="na">name=</span><span class="s">"dubbo"</span> <span class="na">port=</span><span class="s">"12345"</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>以上装配方式不予推荐，推荐使用 Annotation 配置，因此可以换成 Spring <code class="highlighter-rouge">@Configuration</code> Bean 的形式：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">config</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.alibaba.dubbo.config.ApplicationConfig</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.alibaba.dubbo.config.ProtocolConfig</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.alibaba.dubbo.config.RegistryConfig</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.alibaba.dubbo.config.spring.context.annotation.DubboComponentScan</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>

<span class="cm">/**
 * 服务提供方配置
 *
 * @author &lt;a href="mailto:mercyblitz@gmail.com"&gt;Mercy&lt;/a&gt;
 */</span>
<span class="nd">@Configuration</span>
<span class="nd">@DubboComponentScan</span><span class="o">(</span><span class="s">"com.alibaba.dubbo.demo.provider"</span><span class="o">)</span> <span class="c1">// 扫描 Dubbo 组件</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProviderConfiguration</span> <span class="o">{</span>

    <span class="cm">/**
     * 当前应用配置
     */</span>
    <span class="nd">@Bean</span><span class="o">(</span><span class="s">"dubbo-annotation-provider"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">ApplicationConfig</span> <span class="nf">applicationConfig</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">ApplicationConfig</span> <span class="n">applicationConfig</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ApplicationConfig</span><span class="o">();</span>
        <span class="n">applicationConfig</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"dubbo-annotation-provider"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">applicationConfig</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 当前连接注册中心配置
     */</span>
    <span class="nd">@Bean</span><span class="o">(</span><span class="s">"my-registry"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">RegistryConfig</span> <span class="nf">registryConfig</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">RegistryConfig</span> <span class="n">registryConfig</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RegistryConfig</span><span class="o">();</span>
        <span class="n">registryConfig</span><span class="o">.</span><span class="na">setAddress</span><span class="o">(</span><span class="s">"N/A"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">registryConfig</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 当前连接注册中心配置
     */</span>
    <span class="nd">@Bean</span><span class="o">(</span><span class="s">"dubbo"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">ProtocolConfig</span> <span class="nf">protocolConfig</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">ProtocolConfig</span> <span class="n">protocolConfig</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProtocolConfig</span><span class="o">();</span>
        <span class="n">protocolConfig</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"dubbo"</span><span class="o">);</span>
        <span class="n">protocolConfig</span><span class="o">.</span><span class="na">setPort</span><span class="o">(</span><span class="mi">12345</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">protocolConfig</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h6 id="服务提供方引导类">服务提供方引导类</h6>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">bootstrap</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.alibaba.dubbo.demo.DemoService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.alibaba.dubbo.demo.config.ProviderConfiguration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.AnnotationConfigApplicationContext</span><span class="o">;</span>

<span class="cm">/**
 * 服务提供方引导类
 *
 * @author &lt;a href="mailto:mercyblitz@gmail.com"&gt;Mercy&lt;/a&gt;
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProviderBootstrap</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 创建 Annotation 配置上下文</span>
        <span class="n">AnnotationConfigApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AnnotationConfigApplicationContext</span><span class="o">();</span>
        <span class="c1">// 注册配置 Bean</span>
        <span class="n">context</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">ProviderConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="c1">// 启动上下文</span>
        <span class="n">context</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>
        <span class="c1">// 获取 DemoService Bean</span>
        <span class="n">DemoService</span> <span class="n">demoService</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">DemoService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="c1">// 执行 sayHello 方法</span>
        <span class="n">String</span> <span class="n">message</span> <span class="o">=</span> <span class="n">demoService</span><span class="o">.</span><span class="na">sayHello</span><span class="o">(</span><span class="s">"World"</span><span class="o">);</span>
        <span class="c1">// 控制台输出信息</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>
    
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="highlighter-rouge">ProviderBootstrap</code> 启动并执行后，控制输出与预期一致：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>Hello , World
</pre></td></tr></tbody></table></code></pre></div></div>

<p>以上直接结果说明 <code class="highlighter-rouge">@DubboComponentScan("com.alibaba.dubbo.demo.provider")</code> 扫描后，标注 Dubbo <code class="highlighter-rouge">@Service</code> 的 <code class="highlighter-rouge">AnnotationDemoService</code> 被注册成 Spring Bean，可从 Spring ApplicationContext 自由获取。</p>

<h5 id="服务消费方reference">服务消费方（<code class="highlighter-rouge">@Reference</code>）</h5>

<h6 id="服务-demoservice">服务 <code class="highlighter-rouge">DemoService</code></h6>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">consumer</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.alibaba.dubbo.config.annotation.Reference</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.alibaba.dubbo.demo.DemoService</span><span class="o">;</span>

<span class="cm">/**
 * Annotation 驱动 {@link DemoService} 消费方
 *
 * @author &lt;a href="mailto:mercyblitz@gmail.com"&gt;Mercy&lt;/a&gt;
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AnnotationDemoServiceConsumer</span> <span class="o">{</span>

    <span class="nd">@Reference</span><span class="o">(</span><span class="n">url</span> <span class="o">=</span> <span class="s">"dubbo://127.0.0.1:12345"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">DemoService</span> <span class="n">demoService</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">doSayHell</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">demoService</span><span class="o">.</span><span class="na">sayHello</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h6 id="服务消费方-annotation-配置">服务消费方 Annotation 配置</h6>

<p>与服务提供方配置类似，服务消费方也许 Dubbo 相关配置 Bean - <code class="highlighter-rouge">ConsumerConfiguration</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">config</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.alibaba.dubbo.config.ApplicationConfig</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.alibaba.dubbo.config.RegistryConfig</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.alibaba.dubbo.config.spring.context.annotation.DubboComponentScan</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.alibaba.dubbo.demo.consumer.AnnotationDemoServiceConsumer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>

<span class="cm">/**
 * 服务消费方配置
 *
 * @author &lt;a href="mailto:mercyblitz@gmail.com"&gt;Mercy&lt;/a&gt;
 */</span>
<span class="nd">@Configuration</span>
<span class="nd">@DubboComponentScan</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConsumerConfiguration</span> <span class="o">{</span>

    <span class="cm">/**
     * 当前应用配置
     */</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">ApplicationConfig</span> <span class="nf">applicationConfig</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">ApplicationConfig</span> <span class="n">applicationConfig</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ApplicationConfig</span><span class="o">();</span>
        <span class="n">applicationConfig</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"dubbo-annotation-consumer"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">applicationConfig</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 当前连接注册中心配置
     */</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">RegistryConfig</span> <span class="nf">registryConfig</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">RegistryConfig</span> <span class="n">registryConfig</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RegistryConfig</span><span class="o">();</span>
        <span class="n">registryConfig</span><span class="o">.</span><span class="na">setAddress</span><span class="o">(</span><span class="s">"N/A"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">registryConfig</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 注册 AnnotationDemoServiceConsumer，@DubboComponentScan 将处理其中 @Reference 字段。
     * 如果 AnnotationDemoServiceConsumer 非 Spring Bean 的话，
     * 即使 @DubboComponentScan 指定 package 也不会进行处理，与 Spring @Autowired 同理
     */</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">AnnotationDemoServiceConsumer</span> <span class="nf">annotationDemoServiceConsumer</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">AnnotationDemoServiceConsumer</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h6 id="服务消费方引导类">服务消费方引导类</h6>

<p>服务消费方需要先引导服务提供方，下面的实例将会启动两个 Spring 应用上下文，首先引导服务提供方 Spring 应用上下文，同时，需要复用前面Annotation 配置 <code class="highlighter-rouge">ProviderConfiguration</code>：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>    <span class="cm">/**
     * 启动服务提供方上下文
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">startProviderContext</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// 创建 Annotation 配置上下文</span>
        <span class="n">AnnotationConfigApplicationContext</span> <span class="n">providerContext</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AnnotationConfigApplicationContext</span><span class="o">();</span>
        <span class="c1">// 注册配置 Bean</span>
        <span class="n">providerContext</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">ProviderConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="c1">// 启动服务提供方上下文</span>
        <span class="n">providerContext</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>然后引导服务消费方Spring 应用上下文：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>    <span class="cm">/**
     * 启动并且返回服务消费方上下文
     *
     * @return AnnotationConfigApplicationContext
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">ApplicationContext</span> <span class="nf">startConsumerContext</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// 创建服务消费方 Annotation 配置上下文</span>
        <span class="n">AnnotationConfigApplicationContext</span> <span class="n">consumerContext</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AnnotationConfigApplicationContext</span><span class="o">();</span>
        <span class="c1">// 注册服务消费方配置 Bean</span>
        <span class="n">consumerContext</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">ConsumerConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="c1">// 启动服务消费方上下文</span>
        <span class="n">consumerContext</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>
        <span class="c1">// 返回服务消费方 Annotation 配置上下文</span>
        <span class="k">return</span> <span class="n">consumerContext</span><span class="o">;</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>完整的引导类实现：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">alibaba</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">bootstrap</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.alibaba.dubbo.demo.config.ConsumerConfiguration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.alibaba.dubbo.demo.config.ProviderConfiguration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.alibaba.dubbo.demo.consumer.AnnotationDemoServiceConsumer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.ApplicationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.AnnotationConfigApplicationContext</span><span class="o">;</span>

<span class="cm">/**
 * 服务消费端引导类
 *
 * @author &lt;a href="mailto:mercyblitz@gmail.com"&gt;Mercy&lt;/a&gt;
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConsumerBootstrap</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 启动服务提供方上下文</span>
        <span class="n">startProviderContext</span><span class="o">();</span>
        <span class="c1">// 启动并且返回服务消费方上下文</span>
        <span class="n">ApplicationContext</span> <span class="n">consumerContext</span> <span class="o">=</span> <span class="n">startConsumerContext</span><span class="o">();</span>
        <span class="c1">// 获取 AnnotationDemoServiceConsumer Bean</span>
        <span class="n">AnnotationDemoServiceConsumer</span> <span class="n">consumer</span> <span class="o">=</span> <span class="n">consumerContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">AnnotationDemoServiceConsumer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="c1">// 执行 doSayHello 方法</span>
        <span class="n">String</span> <span class="n">message</span> <span class="o">=</span> <span class="n">consumer</span><span class="o">.</span><span class="na">doSayHello</span><span class="o">(</span><span class="s">"World"</span><span class="o">);</span>
        <span class="c1">// 输出执行结果</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 启动并且返回服务消费方上下文
     *
     * @return AnnotationConfigApplicationContext
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">ApplicationContext</span> <span class="nf">startConsumerContext</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// 创建服务消费方 Annotation 配置上下文</span>
        <span class="n">AnnotationConfigApplicationContext</span> <span class="n">consumerContext</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AnnotationConfigApplicationContext</span><span class="o">();</span>
        <span class="c1">// 注册服务消费方配置 Bean</span>
        <span class="n">consumerContext</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">ConsumerConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="c1">// 启动服务消费方上下文</span>
        <span class="n">consumerContext</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>
        <span class="c1">// 返回服务消费方 Annotation 配置上下文</span>
        <span class="k">return</span> <span class="n">consumerContext</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 启动服务提供方上下文
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">startProviderContext</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// 创建 Annotation 配置上下文</span>
        <span class="n">AnnotationConfigApplicationContext</span> <span class="n">providerContext</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AnnotationConfigApplicationContext</span><span class="o">();</span>
        <span class="c1">// 注册配置 Bean</span>
        <span class="n">providerContext</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">ProviderConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="c1">// 启动服务提供方上下文</span>
        <span class="n">providerContext</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>运行<code class="highlighter-rouge">ConsumerBootstrap</code>结果，仍然符合期望，<code class="highlighter-rouge">AnnotationDemoServiceConsumer</code> 输出：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>Hello , World
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="spring-aop-支持">Spring AOP 支持</h4>

<p>前面提到 <code class="highlighter-rouge">&lt;dubbo:annotation&gt; </code>  注册 Dubbo <code class="highlighter-rouge">@Service</code> 组件后，在 Spring AOP 支持方面存在问题。事务作为 Spring AOP 的功能扩展，自然也会在 <code class="highlighter-rouge">&lt;dubbo:annotation&gt; </code>中不支持。</p>

<p><code class="highlighter-rouge">@DubboComponentScan</code> 针对以上问题，实现了对 Spring AOP 是完全兼容。将上述服务提供方 Annotation 配置做出一定的调整，标注<code class="highlighter-rouge">@EnableTransactionManagement</code> 以及自定义实现<code class="highlighter-rouge">PlatformTransactionManager</code> :</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="nd">@Configuration</span>
<span class="nd">@DubboComponentScan</span><span class="o">(</span><span class="s">"com.alibaba.dubbo.demo.provider"</span><span class="o">)</span> <span class="c1">// 扫描 Dubbo 组件</span>
<span class="nd">@EnableTransactionManagement</span> <span class="c1">// 激活事务管理</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProviderConfiguration</span> <span class="o">{</span>
  <span class="c1">// 省略其他配置 Bean 定义</span>
  
    <span class="cm">/**
     * 自定义事务管理器
     */</span>
    <span class="nd">@Bean</span>
    <span class="nd">@Primary</span>
    <span class="kd">public</span> <span class="n">PlatformTransactionManager</span> <span class="nf">transactionManager</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">PlatformTransactionManager</span><span class="o">()</span> <span class="o">{</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">TransactionStatus</span> <span class="nf">getTransaction</span><span class="o">(</span><span class="n">TransactionDefinition</span> <span class="n">definition</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">TransactionException</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"get transaction ..."</span><span class="o">);</span>
                <span class="k">return</span> <span class="k">new</span> <span class="nf">SimpleTransactionStatus</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">commit</span><span class="o">(</span><span class="n">TransactionStatus</span> <span class="n">status</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">TransactionException</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"commit transaction ..."</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">rollback</span><span class="o">(</span><span class="n">TransactionStatus</span> <span class="n">status</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">TransactionException</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"rollback transaction ..."</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">};</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>同时调整 <code class="highlighter-rouge">AnnotationDemoService</code>  - 增加<code class="highlighter-rouge">@Transactional</code> 注解：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nd">@Service</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AnnotationDemoService</span> <span class="kd">implements</span> <span class="n">DemoService</span> <span class="o">{</span>
	<span class="c1">// 省略实现，保持不变</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>再次运行<code class="highlighter-rouge">ConsumerBootstrap</code> , 观察控制台输出内容：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>get transaction ...
commit transaction ...
Hello , World
</pre></td></tr></tbody></table></code></pre></div></div>

<p>输入内容中多处了两行，说明自定义 <code class="highlighter-rouge">PlatformTransactionManager</code> <code class="highlighter-rouge">getTransaction(TransactionDefinition)</code> 以及 <code class="highlighter-rouge">commit(TransactionStatus) </code> 方法被执行，进而说明 <code class="highlighter-rouge">AnnotationDemoService</code> 的<code class="highlighter-rouge">sayHello(String)</code> 方法执行时，事务也伴随执行。</p>

<h4 id="注意事项">注意事项</h4>

<p><code class="highlighter-rouge">ConsumerConfiguration</code> 上的  <code class="highlighter-rouge">@DubboComponentScan</code> 并没有指定 <code class="highlighter-rouge">basePackages</code> 扫描，这种情况会将<code class="highlighter-rouge">ConsumerConfiguration</code>  当做 <code class="highlighter-rouge">basePackageClasses</code> ，即扫描<code class="highlighter-rouge">ConsumerConfiguration</code> 所属的 package  <code class="highlighter-rouge">com.alibaba.dubbo.demo.config</code> 以及子 package。由于当前示例中，不存在标注 Dubbo <code class="highlighter-rouge">@Service</code>的类，因此在运行时日志（如果开启的话）会输出警告信息：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>WARN :  [DUBBO] No Spring Bean annotating Dubbo's @Service was found in Spring BeanFactory, dubbo version: 2.0.0, current host: 127.0.0.1
</pre></td></tr></tbody></table></code></pre></div></div>

<p>以上信息大可不必担忧，因为 <code class="highlighter-rouge">@DubboComponentScan</code>  除了扫描 Dubbo <code class="highlighter-rouge">@Service</code> 组件以外，还将处理 <code class="highlighter-rouge">@Reference</code>字段注入。然而读者特别关注<code class="highlighter-rouge">@Reference</code>字段注入的规则。</p>

<p>以上实现为例，<code class="highlighter-rouge">AnnotationDemoServiceConsumer</code> 必须申明为 Spring  <code class="highlighter-rouge">@Bean</code> 或者 <code class="highlighter-rouge">@Component</code>（或者其派生注解），否则 <code class="highlighter-rouge">@DubboComponentScan</code> 不会主动将标注 <code class="highlighter-rouge">@Reference</code>字段所在的声明类提成为 Spring Bean，换句话说，如果 <code class="highlighter-rouge">@Reference</code>字段所在的声明类不是 Spring Bean 的话， <code class="highlighter-rouge">@DubboComponentScan</code> 不会处理<code class="highlighter-rouge">@Reference</code>注入，其原理与 Spring <code class="highlighter-rouge">@Autowired</code> 一致。</p>

<p>以上使用不当可能会导致相关问题，如 GitHub 上曾有小伙伴提问：https://github.com/alibaba/dubbo/issues/825</p>

<blockquote>
  <p><strong>li362692680</strong> 提问：</p>

  <blockquote>
    <p>@DubboComponentScan注解在消费端扫描包时扫描的是 @Service注解？？不是@Reference注解？？
启动时报
DubboComponentScanRegistrar-85]-[main]-[INFO] 0 annotated @Service Components { [] }</p>
  </blockquote>

  <p>笔者(<strong>mercyblitz</strong>)回复：</p>

  <blockquote>
    <p><code class="highlighter-rouge">@Reference</code> 类似于 <code class="highlighter-rouge">@Autowired</code> 一样，首先其申明的类必须被 Spring 上下文当做一个Bean，因此，Dubbo 并没有直接将 <code class="highlighter-rouge">@Reference</code>  字段所在的类提升成 Bean。</p>

    <p>综上所述，这并不是一个问题，而是用法不当！</p>
  </blockquote>
</blockquote>

<h4 id="已知问题">已知问题</h4>

<p>最新发布的 Dubbo <code class="highlighter-rouge">2.5.8</code> 中，<code class="highlighter-rouge">@DubboComponentScan</code>  在以下特殊场景下存在 Spring <code class="highlighter-rouge">@Service</code> 不兼容情况：</p>

<blockquote>
  <p>假设有两个服务实现类 <code class="highlighter-rouge">A</code> 和 <code class="highlighter-rouge">B</code>，同时存放在<code class="highlighter-rouge">com.acme</code> 包下：</p>

  <ul>
    <li><code class="highlighter-rouge">A</code> 标注  Dubbo <code class="highlighter-rouge">@Service</code></li>
    <li><code class="highlighter-rouge">B</code> 标注  Dubbo <code class="highlighter-rouge">@Service</code> 和 Spring <code class="highlighter-rouge">@Service</code></li>
  </ul>

  <p>当 Spring <code class="highlighter-rouge">@ComponentScan</code> 先扫描<code class="highlighter-rouge">com.acme</code> 包时，<code class="highlighter-rouge">B</code> 被当做 Spring Bean 的候选类。随后，<code class="highlighter-rouge">@DubboComponentScan</code> 也扫描相同的包。当应用启动时，<code class="highlighter-rouge">A</code> 和 <code class="highlighter-rouge">B</code>  虽然都是  Spring Bean，可仅 <code class="highlighter-rouge">A</code> 能够暴露 Dubbo 服务，<code class="highlighter-rouge">B</code> 则丢失。</p>
</blockquote>

<p>问题版本：<code class="highlighter-rouge">2.5.7</code>、<code class="highlighter-rouge">2.5.8</code></p>

<p>问题详情：https://github.com/alibaba/dubbo/issues/1120</p>

<p>修复版本：<code class="highlighter-rouge">2.5.9</code>（下个版本）</p>

